---
- name: Enable ssh service
  ansible.builtin.systemd:
    name: ssh
    enabled: yes

- name: Put the wpa configuration in /boot 
  template:
    src: wpa-suplicant-conf.j2
    dest: /boot/wpa_supplicant.conf
    owner: root
    group: root
  tags: wpa-configuration

- name: Update and upgrade apt packages ( can take soooooooooo muchhhhhhhhhhhhh time, don't worry !! )
  apt:
    upgrade: yes
    update_cache: yes
    cache_valid_time: 86400 

- name: Change user password
  command: "echo pi:{{new_password}} | chpasswd -e"

- name: Install pigpio
  apt:
    pkg:
    - pigpio 
    - python3-pigpio
    state: latest
  notify: Start pigpiod service

- name: Enable I2C
  command: raspi-config nonint do_i2c 1

- name: Enable camera
  command: raspi-config nonint do_camera 1  

- name: modifie the dhcpd5 service
  template:
    src: dhcpd.service.j2
    dest: /lib/systemd/system/dhcpcd.service
    owner: root
    group: root
  # We won't notify to restart DHCP service because it could cause Ansible deconnexion
  # Change will be taken into account at restart, it's not an issue as our fixe covers
  # timeout issue at the first boot of the raspberry pi.
